name: Build SuperFlix

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. CHECKOUT
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      # 2. SETUP
      - name: Setup
        run: |
          chmod +x gradlew
          echo "=== VERIFICANDO ARQUIVOS ==="
          ls -la SuperFlix/src/main/kotlin/com/SuperFlix/

      # 3. DEBUG DO CÃ“DIGO
      - name: Debug do cÃ³digo
        run: |
          echo "=== DEBUG DO CÃ“DIGO ==="
          
          # Verifica se tem as variÃ¡veis crÃ­ticas
          echo "ðŸ” Buscando 'tmdbApiKey' no SuperFlix.kt:"
          grep -n "tmdbApiKey = " SuperFlix/src/main/kotlin/com/SuperFlix/SuperFlix.kt || echo "âŒ NÃƒO ENCONTRADO!"
          
          echo ""
          echo "ðŸ” Buscando 'Config.TMDB':"
          grep -n "Config\." SuperFlix/src/main/kotlin/com/SuperFlix/SuperFlix.kt || echo "âŒ NÃƒO ENCONTRADO!"
          
          # Mostra primeiras 25 linhas
          echo ""
          echo "ðŸ“„ Primeiras 25 linhas do SuperFlix.kt:"
          sed -n '1,25p' SuperFlix/src/main/kotlin/com/SuperFlix/SuperFlix.kt | cat -n

      # 4. VERIFICAR/CRIAR TEMPLATE
      - name: Preparar template
        run: |
          echo "=== PREPARANDO TEMPLATE ==="
          
          # Cria diretÃ³rios se nÃ£o existirem
          mkdir -p SuperFlix/src/main/kotlin/com/SuperFlix
          
          # Cria template (substitui se existir)
          cat > SuperFlix/src/main/kotlin/com/SuperFlix/Config.kt.template << 'EOF'
          package com.SuperFlix

          object Config {
              const val TMDB_API_KEY = "@@TMDB_API_KEY@@"
              const val TMDB_BASE_URL = "https://api.themoviedb.org/3"
              const val TMDB_IMAGE_URL = "https://image.tmdb.org/t/p"
              const val DEBUG_MODE = true
              const val REQUEST_TIMEOUT = 10000L
              
              fun logConfig() {
                  println("ðŸŽ¬ SuperFlix Config")
                  println("ðŸ“ TMDB Key: ${TMDB_API_KEY.length} chars")
              }
          }
          EOF
          
          echo "âœ… Template criado/atualizado"

      # 5. INJETAR CHAVE
      - name: Inject TMDB API Key
        run: |
          echo "=== INJETANDO CHAVE ==="
          
          KEY="${{ secrets.TMDB_API_KEY }}"
          
          if [ -z "$KEY" ]; then
            echo "âŒ ERRO: TMDB_API_KEY nÃ£o configurada!"
            echo "Configure em: Settings â†’ Secrets and variables â†’ Actions"
            exit 1
          fi
          
          echo "ðŸ”‘ Chave recebida: ${#KEY} chars"
          
          # Cria Config.kt com a chave real
          cat > SuperFlix/src/main/kotlin/com/SuperFlix/Config.kt << EOF
          package com.SuperFlix

          object Config {
              const val TMDB_API_KEY = "$KEY"
              const val TMDB_BASE_URL = "https://api.themoviedb.org/3"
              const val TMDB_IMAGE_URL = "https://image.tmdb.org/t/p"
              const val DEBUG_MODE = true
              const val REQUEST_TIMEOUT = 10000L
              
              fun logConfig() {
                  println("ðŸŽ¬ SuperFlix Config")
                  println("ðŸ“ TMDB Key: \${TMDB_API_KEY.length} chars")
              }
          }
          EOF
          
          echo "âœ… Config.kt criado com chave"
          echo "ðŸ“ VerificaÃ§Ã£o (mascarada):"
          grep "TMDB_API_KEY" SuperFlix/src/main/kotlin/com/SuperFlix/Config.kt | sed 's/"[^"]*\("[^"]*"\)/"***\1/'

      # 6. BUILD COM VERIFICAÃ‡ÃƒO DE ERROS
      - name: Build com verificaÃ§Ã£o
        run: |
          echo "=== BUILD COM VERIFICAÃ‡ÃƒO ==="
          
          echo "ðŸ”„ Compilando..."
          ./gradlew :SuperFlix:assembleDebug 2>&1 | tee build.log
          
          BUILD_RESULT=$?
          
          if [ $BUILD_RESULT -eq 0 ]; then
            echo "âœ… BUILD SUCESSO!"
            
            # Procura o .cs3 gerado
            CS3_FILE=$(find . -name "*.cs3" -type f | head -1)
            if [ -f "$CS3_FILE" ]; then
              echo "ðŸ“¦ Plugin gerado: $CS3_FILE"
              echo "ðŸ“ Tamanho: $(ls -lh "$CS3_FILE" | awk '{print $5}')"
            fi
          else
            echo "âŒ BUILD FALHOU!"
            echo ""
            echo "=== ERROS ENCONTRADOS ==="
            grep -i "error\|fail\|unresolved" build.log | head -20
            echo ""
            echo "=== LOG COMPLETO (Ãºltimas 50 linhas) ==="
            tail -50 build.log
            exit 1
          fi

      # 7. VERIFICAÃ‡ÃƒO PROFUNDA DO .CS3
      - name: VerificaÃ§Ã£o profunda
        if: success()
        run: |
          echo "=== VERIFICAÃ‡ÃƒO PROFUNDA ==="
          
          CS3_FILE=$(find . -name "*.cs3" -type f | head -1)
          
          if [ -f "$CS3_FILE" ]; then
            echo "ðŸ” Analisando: $CS3_FILE"
            
            # Verifica se Ã© um ZIP vÃ¡lido
            echo "ðŸ“¦ Ã‰ arquivo ZIP? (deve ser sim)"
            file "$CS3_FILE"
            
            # Tenta extrair strings
            echo ""
            echo "ðŸ”Ž Buscando referÃªncias no .cs3:"
            
            # Procura por padrÃµes
            strings "$CS3_FILE" | grep -i "tmdb\|config\|superflix" | head -10
            
            # Conta ocorrÃªncias
            TMDB_COUNT=$(strings "$CS3_FILE" | grep -i "tmdb" | wc -l)
            CONFIG_COUNT=$(strings "$CS3_FILE" | grep -i "config" | wc -l)
            
            echo ""
            echo "ðŸ“Š EstatÃ­sticas:"
            echo "   ReferÃªncias TMDB: $TMDB_COUNT"
            echo "   ReferÃªncias Config: $CONFIG_COUNT"
            
            if [ $TMDB_COUNT -gt 0 ] && [ $CONFIG_COUNT -gt 0 ]; then
              echo "âœ… Plugin parece correto!"
            else
              echo "âš ï¸  Poucas referÃªncias encontradas"
            fi
          else
            echo "âŒ Nenhum .cs3 encontrado!"
          fi

      # 8. TESTE DE FUNCIONALIDADE (SIMULAÃ‡ÃƒO)
      - name: Teste de funcionalidade
        if: success()
        run: |
          echo "=== TESTE DE FUNCIONALIDADE ==="
          
          # Cria um teste simples
          cat > test_config.kt << 'EOF'
          package com.SuperFlix
          
          fun testConfig() {
              println("=== TESTE CONFIG ===")
              println("Chave: ${Config.TMDB_API_KEY.length} chars")
              println("URL Base: ${Config.TMDB_BASE_URL}")
              println("URL Imagem: ${Config.TMDB_IMAGE_URL}")
          }
          EOF
          
          echo "ðŸ§ª Teste criado"
          echo "âœ… Se o build passou, o plugin deve funcionar!"
          echo ""
          echo "ðŸŽ¯ PRÃ“XIMOS PASSOS:"
          echo "1. Instale o plugin no CloudStream"
          echo "2. Teste buscar um filme"
          echo "3. Verifique logs no CloudStream (Config â†’ Log)"
          echo "4. Se mostrar 'TMDB Key: 32 chars', estÃ¡ funcionando!"

      # 9. LIMPEZA SEGURA
      - name: Limpeza
        run: |
          echo "=== LIMPEZA ==="
          
          # Remove arquivos sensÃ­veis
          rm -f SuperFlix/src/main/kotlin/com/SuperFlix/Config.kt
          rm -f test_config.kt build.log
          
          echo "âœ… Arquivos sensÃ­veis removidos"
          echo "ðŸ“„ Template mantido para prÃ³ximos builds"

      # 10. RELATÃ“RIO FINAL
      - name: RelatÃ³rio final
        if: always()
        run: |
          echo "=== RELATÃ“RIO FINAL ==="
          
          if [ -f "build.log" ]; then
            if grep -q "BUILD SUCCESSFUL" build.log; then
              echo "ðŸŽ‰ BUILD COMPLETO COM SUCESSO!"
              echo ""
              echo "âœ… O que funcionou:"
              echo "   - Template criado/injetado"
              echo "   - Config.kt gerado com chave"
              echo "   - Plugin .cs3 compilado"
              echo ""
              echo "ðŸ“¦ PrÃ³ximos passos:"
              echo "   1. Encontre o arquivo .cs3 em builds/"
              echo "   2. Adicione ao CloudStream"
              echo "   3. Teste com um filme"
              echo "   4. Verifique logs no CloudStream"
            else
              echo "âŒ BUILD FALHOU"
              echo "Consulte os logs acima para detalhes"
            fi
          else
            echo "âš ï¸  Log nÃ£o encontrado"
          fi
