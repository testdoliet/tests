name: Build SuperFlix

on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '11'
          
      - name: Build
        run: |
          chmod +x gradlew
          
          echo "üîÑ Iniciando build..."
          
          # Executa sem filtro
          output=$(./gradlew :SuperFlix:assembleDebug --stacktrace 2>&1)
          status=$?
          
          if [ $status -eq 0 ]; then
            echo "‚úÖ Build conclu√≠do"
            
            # Sucesso - mostra resumo
            CS3_FILE=$(find . -name "*.cs3" -type f | head -1)
            if [ -f "$CS3_FILE" ]; then
              echo "üì¶ $(basename "$CS3_FILE")"
              
              # Cria release
              mkdir -p _build
              cp "$CS3_FILE" "_build/"
              
              # JSONs
              echo '[{"name":"SuperFlix","url":"https://raw.githubusercontent.com/'${{ github.repository }}'/main/_build/'$(basename "$CS3_FILE")'"}]' > _build/plugins.json
              
              # Commit
              git config user.name "GitHub Bot"
              git config user.email "bot@github.com"
              git add _build/
              git commit -m "build" -q
              git push -q
              
              echo ""
              echo "üîó https://raw.githubusercontent.com/${{ github.repository }}/main/_build/$(basename "$CS3_FILE")"
            fi
          else
            # Falha - mostra ERROS REAIS
            echo ""
            echo "üî• ERROS:"
            echo ""
            
            # Extrai erros de compila√ß√£o
            echo "$output" | grep -E "^e: |error:|FAIL|‚úó|‚ùå" || \
            echo "$output" | tail -30
            
            exit 1
          fi
